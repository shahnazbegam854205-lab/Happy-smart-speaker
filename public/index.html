<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Payment Announcer</title>
    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="/manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #10b981; min-height: 100vh; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header { background: white; padding: 30px; border-radius: 15px 15px 0 0; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #10b981; font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1rem; }
        
        /* MAIN CARD */
        .main-card { background: white; padding: 30px; border-radius: 0 0 15px 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-top: 5px; }
        
        /* STATUS */
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .status-box { background: #f8fafc; padding: 15px; border-radius: 10px; border-left: 4px solid #ddd; }
        .status-box.active { border-left-color: #10b981; }
        .status-box.inactive { border-left-color: #ef4444; }
        .status-title { font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .status-value { font-size: 14px; font-weight: 600; }
        
        /* BUTTONS */
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #d1d5db; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
        .btn-icon { font-size: 18px; }
        
        /* INSTALL PROMPT */
        .install-prompt { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; display: none; }
        .install-prompt.show { display: block; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PAYMENTS */
        .payments-section { margin: 30px 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h3 { color: #374151; }
        .payments-list { max-height: 400px; overflow-y: auto; }
        .payment-card { background: #f8fafc; padding: 20px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #10b981; }
        .payment-amount { font-size: 24px; font-weight: bold; color: #059669; }
        .payment-sender { font-weight: 600; color: #374151; }
        
        /* LOGS */
        .logs-section { background: #f8fafc; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .logs-list { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #e5e7eb; }
        
        /* TOAST */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #059669; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; display: none; }
        .toast.show { display: block; animation: toastIn 0.3s ease; }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* HIDDEN */
        .hidden { display: none !important; }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .status-grid, .btn-group { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>üí∞ Payment Announcer</h1>
            <p class="subtitle">Real-time payment announcements with voice alerts</p>
        </header>
        
        <!-- INSTALL PROMPT -->
        <div class="install-prompt" id="installPrompt">
            <p style="margin-bottom: 10px; font-size: 18px;">üì± Install this app for better experience</p>
            <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">Get home screen icon, offline access, and push notifications</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="installNowBtn" class="btn" style="background: white; color: #f59e0b; border: none;">
                    <span class="btn-icon">üì±</span> Install Now
                </button>
                <button id="installLaterBtn" class="btn" style="background: transparent; color: white; border: 2px solid white;">
                    Later
                </button>
            </div>
        </div>
        
        <!-- MAIN CARD -->
        <div class="main-card">
            <!-- STATUS -->
            <div class="status-grid">
                <div class="status-box" id="apiStatusBox">
                    <div class="status-title">API Status</div>
                    <div class="status-value" id="apiStatusText">Checking...</div>
                </div>
                <div class="status-box" id="ttsStatusBox">
                    <div class="status-title">TTS Status</div>
                    <div class="status-value" id="ttsStatusText">Checking...</div>
                </div>
                <div class="status-box" id="monitorStatusBox">
                    <div class="status-title">Monitoring</div>
                    <div class="status-value" id="monitorStatusText">Stopped</div>
                </div>
            </div>
            
            <!-- BUTTONS -->
            <div class="btn-group">
                <button id="startBtn" class="btn btn-primary">
                    <span class="btn-icon">‚ñ∂</span>
                    Start Monitoring
                </button>
                <button id="testBtn" class="btn btn-secondary">
                    <span class="btn-icon">üîä</span>
                    Test Sound
                </button>
                <button id="installBtn" class="btn btn-success hidden">
                    <span class="btn-icon">üì±</span>
                    Install App
                </button>
            </div>
            
            <!-- PAYMENTS -->
            <div class="payments-section">
                <div class="section-header">
                    <h3>Recent Payments</h3>
                    <div>
                        <span id="paymentCount">0</span> payments
                        <button id="clearBtn" class="btn btn-secondary" style="margin-left: 10px; padding: 8px 15px; font-size: 14px;">Clear</button>
                    </div>
                </div>
                <div class="payments-list" id="paymentsList">
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <p>No payments yet</p>
                        <small>Start monitoring to see payments here</small>
                    </div>
                </div>
            </div>
            
            <!-- LOGS -->
            <div class="logs-section">
                <h3 style="margin-bottom: 15px; color: #374151;">Activity Log</h3>
                <div class="logs-list" id="logsList">
                    <div class="log-entry" style="color: #059669;">
                        [<span id="currentTime">10:30:45</span>] System initialized
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast"></div>
    
    <!-- SCRIPT -->
    <script>
        // SIMPLE WORKING PWA INSTALL
        class PaymentApp {
            constructor() {
                // SET YOUR BACKEND URL HERE
                this.backendUrl = 'https://h4ppy-api-getway.vercel.app';
                
                this.isMonitoring = false;
                this.interval = null;
                this.deferredPrompt = null;
                this.isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                
                this.init();
            }
            
            init() {
                console.log('üöÄ Payment App Initializing...');
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Check PWA install
                this.setupPWA();
                
                // Check TTS
                this.checkTTS();
                
                // Check backend
                this.checkBackend();
                
                // Auto start monitoring
                setTimeout(() => {
                    if (localStorage.getItem('autoStart') !== 'false') {
                        this.startMonitoring();
                    }
                }, 1000);
                
                console.log('‚úÖ App Ready');
                this.log('System ready');
            }
            
            updateTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                document.getElementById('currentTime').textContent = timeStr;
            }
            
            setupEventListeners() {
                // Start/Stop button
                document.getElementById('startBtn').addEventListener('click', () => {
                    if (this.isMonitoring) {
                        this.stopMonitoring();
                    } else {
                        this.startMonitoring();
                    }
                });
                
                // Test button
                document.getElementById('testBtn').addEventListener('click', () => {
                    this.testAnnouncement();
                });
                
                // Install button
                document.getElementById('installBtn').addEventListener('click', () => {
                    this.showInstallPrompt();
                });
                
                // Install Now button in prompt
                document.getElementById('installNowBtn').addEventListener('click', () => {
                    this.installPWA();
                });
                
                // Install Later button
                document.getElementById('installLaterBtn').addEventListener('click', () => {
                    this.hideInstallPrompt();
                });
                
                // Clear button
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearPayments();
                });
            }
            
            // üî• PWA INSTALL FIX
            setupPWA() {
                console.log('üîß Setting up PWA...');
                
                // Check if already installed
                if (this.isStandalone) {
                    console.log('üì± Already installed as PWA');
                    document.getElementById('installBtn').classList.add('hidden');
                    document.getElementById('installPrompt').classList.remove('show');
                    return;
                }
                
                // Listen for beforeinstallprompt event
                window.addEventListener('beforeinstallprompt', (e) => {
                    console.log('üì± beforeinstallprompt fired!');
                    e.preventDefault();
                    this.deferredPrompt = e;
                    
                    // Show install button immediately
                    document.getElementById('installBtn').classList.remove('hidden');
                    
                    // Show prompt after 3 seconds
                    setTimeout(() => {
                        if (this.deferredPrompt && !this.isStandalone) {
                            document.getElementById('installPrompt').classList.add('show');
                        }
                    }, 3000);
                });
                
                // Listen for appinstalled event
                window.addEventListener('appinstalled', (e) => {
                    console.log('üéâ PWA installed successfully!');
                    this.isStandalone = true;
                    document.getElementById('installBtn').classList.add('hidden');
                    document.getElementById('installPrompt').classList.remove('show');
                    this.showToast('App installed successfully!');
                    this.log('PWA installed');
                });
                
                // For iOS - check standalone mode
                if (window.navigator.standalone === true) {
                    console.log('üì± iOS standalone mode detected');
                    this.isStandalone = true;
                    document.getElementById('installBtn').classList.add('hidden');
                    document.getElementById('installPrompt').classList.remove('show');
                }
                
                // Register Service Worker
                this.registerServiceWorker();
            }
            
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registered:', registration);
                            this.log('Service Worker registered');
                        })
                        .catch(error => {
                            console.log('‚ùå Service Worker failed:', error);
                            this.log('Service Worker failed', true);
                        });
                }
            }
            
            showInstallPrompt() {
                if (!this.deferredPrompt) {
                    this.showToast('Install feature not available');
                    return;
                }
                
                // Show the install prompt
                this.deferredPrompt.prompt();
                
                // Wait for user response
                this.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ User accepted install');
                        this.showToast('Installing...');
                    } else {
                        console.log('‚ùå User declined install');
                        this.showToast('Installation cancelled');
                    }
                    this.deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                });
            }
            
            installPWA() {
                if (!this.deferredPrompt) {
                    this.showToast('Install not available');
                    return;
                }
                
                console.log('üì± Triggering install...');
                this.deferredPrompt.prompt();
                
                this.deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User choice:', choiceResult.outcome);
                    this.deferredPrompt = null;
                    
                    if (choiceResult.outcome === 'accepted') {
                        this.showToast('App installed successfully!');
                        document.getElementById('installBtn').classList.add('hidden');
                        document.getElementById('installPrompt').classList.remove('show');
                    }
                });
            }
            
            hideInstallPrompt() {
                document.getElementById('installPrompt').classList.remove('show');
            }
            
            checkTTS() {
                if ('speechSynthesis' in window) {
                    this.updateStatus('tts', true, 'TTS Available');
                    this.log('TTS available');
                } else {
                    this.updateStatus('tts', false, 'TTS Not Supported');
                    this.log('TTS not supported', true);
                }
            }
            
            async checkBackend() {
                try {
                    const response = await fetch(this.backendUrl);
                    if (response.ok) {
                        this.updateStatus('api', true, 'Connected');
                        this.log('Backend connected');
                    } else {
                        throw new Error('API error');
                    }
                } catch (error) {
                    this.updateStatus('api', false, 'Disconnected');
                    this.log('Backend connection failed', true);
                }
            }
            
            startMonitoring() {
                this.isMonitoring = true;
                document.getElementById('startBtn').innerHTML = '<span class="btn-icon">‚è∏</span> Stop Monitoring';
                document.getElementById('monitorStatusBox').classList.add('active');
                document.getElementById('monitorStatusText').textContent = 'Running';
                
                this.interval = setInterval(() => {
                    this.checkPayments();
                }, 10000);
                
                this.showToast('Monitoring started');
                this.log('Started monitoring');
            }
            
            stopMonitoring() {
                this.isMonitoring = false;
                document.getElementById('startBtn').innerHTML = '<span class="btn-icon">‚ñ∂</span> Start Monitoring';
                document.getElementById('monitorStatusBox').classList.remove('active');
                document.getElementById('monitorStatusText').textContent = 'Stopped';
                
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
                
                this.showToast('Monitoring stopped');
                this.log('Stopped monitoring');
            }
            
            async checkPayments() {
                try {
                    const response = await fetch(`${this.backendUrl}/api/check-new-sms`);
                    const data = await response.json();
                    
                    if (data.success && data.announcements?.length > 0) {
                        data.announcements.forEach(payment => {
                            this.announcePayment(payment);
                        });
                    }
                    
                    this.log(`Checked: ${data.announcements?.length || 0} new payments`);
                } catch (error) {
                    this.log('Check error: ' + error.message, true);
                }
            }
            
            announcePayment(payment) {
                const { amount, sender } = payment;
                const message = `New payment of ‚Çπ${amount} from ${sender}`;
                
                // Add to UI
                this.addPaymentToUI(payment);
                
                // Play TTS
                this.playTTS(message);
                
                // Show notification
                if (Notification.permission === 'granted') {
                    new Notification('üí∞ Payment Received', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%2310b981"/><text x="50" y="50" font-size="40" text-anchor="middle" dy=".3em" fill="white">üí∞</text></svg>'
                    });
                }
                
                this.showToast(message);
                this.log(`Payment: ‚Çπ${amount} from ${sender}`);
            }
            
            addPaymentToUI(payment) {
                const list = document.getElementById('paymentsList');
                const empty = list.querySelector('.empty-state');
                if (empty) empty.remove();
                
                const div = document.createElement('div');
                div.className = 'payment-card';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div class="payment-amount">‚Çπ${payment.amount}</div>
                        <div class="payment-sender">${payment.sender}</div>
                    </div>
                    <div style="font-size: 14px; color: #6b7280;">
                        <div><strong>Bank:</strong> ${payment.bank || 'Unknown'}</div>
                        <div><strong>Time:</strong> ${new Date(payment.timestamp).toLocaleTimeString()}</div>
                    </div>
                `;
                
                list.prepend(div);
                document.getElementById('paymentCount').textContent = list.children.length;
            }
            
            playTTS(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 1.0;
                    utterance.volume = 1.0;
                    speechSynthesis.speak(utterance);
                }
            }
            
            testAnnouncement() {
                const testPayment = {
                    amount: 5000,
                    sender: 'Test User',
                    bank: 'Test Bank',
                    timestamp: new Date().toISOString()
                };
                
                this.announcePayment(testPayment);
                this.log('Test announcement');
            }
            
            clearPayments() {
                document.getElementById('paymentsList').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <p>No payments yet</p>
                        <small>Start monitoring to see payments here</small>
                    </div>
                `;
                document.getElementById('paymentCount').textContent = '0';
                this.log('Cleared payments');
            }
            
            updateStatus(type, success, message) {
                const box = document.getElementById(`${type}StatusBox`);
                const text = document.getElementById(`${type}StatusText`);
                
                if (box && text) {
                    box.classList.toggle('active', success);
                    box.classList.toggle('inactive', !success);
                    text.textContent = message;
                }
            }
            
            log(message, isError = false) {
                const list = document.getElementById('logsList');
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.style.color = isError ? '#ef4444' : '#059669';
                div.innerHTML = `[${time}] ${message}`;
                
                list.prepend(div);
                
                // Keep only 20 logs
                if (list.children.length > 20) {
                    list.removeChild(list.lastChild);
                }
            }
            
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Create app instance
            window.app = new PaymentApp();
        });
        
        // Debug function
        window.debugPWA = function() {
            console.log('=== PWA DEBUG INFO ===');
            console.log('HTTPS:', window.location.protocol === 'https:');
            console.log('Service Worker:', 'serviceWorker' in navigator);
            console.log('Standalone:', window.matchMedia('(display-mode: standalone)').matches);
            console.log('BeforeInstallPrompt:', window.deferredPrompt || 'Not available');
            console.log('iOS Standalone:', window.navigator.standalone);
            console.log('Manifest:', document.querySelector('link[rel="manifest"]'));
        };
    </script>
</body>
</html>
